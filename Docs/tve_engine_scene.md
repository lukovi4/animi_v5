# TVE Engine ‚Äî –ê—É–¥–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Scene.json –∏ Lottie (Anim-x.json)

**–†–æ–ª—å:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ª–∏–¥–µ—Ä  \
**–û–±–ª–∞—Å—Ç—å:** Scene.json Spec v0.1 + Anim-x.json (Lottie / Bodymovin)  \
**–¶–µ–ª—å:** –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ *—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è end-to-end* –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —Ç–µ–º, *—á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ —Å–ø–µ–∫–µ*, –≤—ã—è–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å.

---

## 0. Executive Summary

–¢–µ–∫—É—â–∞—è –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ—á–Ω—ã–π **—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞** —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Å–∏–ª—å–Ω—ã–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏:

- –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
- –Ω–∞—Ç–∏–≤–Ω—ã–π Metal-–ø–∞–π–ø–ª–∞–π–Ω
- —Ä–µ–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å–æ–∫ –∏ track matte
- —Å—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (fail-fast)

–ü—Ä–∏ —ç—Ç–æ–º **—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Scene.json —Å–ø–µ–∫–µ –Ω–µ–ø–æ–ª–Ω–æ–µ**, –∞ **–ø–æ–¥–¥–µ—Ä–∂–∫–∞ Lottie –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞**. –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ *—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á—ë—Ç–∫–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å—Ç—Ä–æ–≥–æ enforced –≤ –∫–æ–¥–µ*.

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã

üî• **–ü—Ä–æ–±–ª–µ–º—ã Scene.json (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ñ–∏–∫—Å–∏—Ç—å —Å–µ–π—á–∞—Å)**

- –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ loop –¥–ª—è `variant` –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
- `emptyPolicy` –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ media source –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- `background` –∏–∑ scene.json –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è
- `containerClip = slotRectAfterSettle` –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–º
- zip-—Ñ–æ—Ä–º–∞—Ç ScenePackage –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

üî• **–†–∏—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ Lottie**

- Text –∏ Solid —Å–ª–æ–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è (—á–∞—Å—Ç—ã–π –∫–µ–π—Å –≤ AE-—à–∞–±–ª–æ–Ω–∞—Ö)
- –ø–æ–¥–¥–µ—Ä–∂–∫–∞ shape-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ —à–∏—Ä–µ, —á–µ–º –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- shape layers —Ç—Ä–∞–∫—Ç—É—é—Ç—Å—è –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ: –∫–∞–∫ matte-only

üëâ –ë–µ–∑ —Ñ–∏–∫—Å–æ–≤ –¥–∏–∑–∞–π–Ω–µ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å **–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ü–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–ª–∏ –ª–æ–º–∞—é—Ç—Å—è –º–æ–ª—á–∞**.

---

## 1. Scene.json Spec v0.1 ‚Äî –∞—É–¥–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

**–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:** `scene_json_spec_v_0.md`

### 1.1 Canvas –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ü–µ–Ω—ã

| –§–∏—á–∞ | –°–ø–µ–∫–∞ | –ö–æ–¥ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-------|-----|--------|-------------|
| schemaVersion | MUST | –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è | ‚úÖ | –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| canvas (size/fps/duration) | MUST | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ render plan |
| background | optional | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è | ‚ùå | –ú–æ–¥–µ–ª—å –µ—Å—Ç—å, —Ä–µ–Ω–¥–µ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

---

### 1.2 MediaBlocks

| –§–∏—á–∞ | –°–ø–µ–∫–∞ | –ö–æ–¥ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-------|-----|--------|-------------|
| 1..N –±–ª–æ–∫–æ–≤ | MUST | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π |
| rect (canvas coords) | MUST | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è |
| —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ zIndex | MUST | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | Stable sort |
| timing.start/end | MUST | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |

---

### 1.3 containerClip

| –ó–Ω–∞—á–µ–Ω–∏–µ | –°–ø–µ–∫–∞ | –ö–æ–¥ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------|-------|-----|--------|-------------|
| none | allowed | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | |
| slotRect | allowed | –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–æ | ‚úÖ | |
| slotRectAfterSettle | allowed | ‚ùå –í–∞–ª–∏–¥–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç | üî• FIX | –í —Ä–∞–Ω—Ç–∞–π–º–µ –≤–µ–¥—ë—Ç —Å–µ–±—è –∫–∞–∫ slotRect |

**–§–∏–∫—Å:** —Ä–∞–∑—Ä–µ—à–∏—Ç—å `slotRectAfterSettle` –≤ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–µ; –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å warning, –µ—Å–ª–∏ —Å–µ–º–∞–Ω—Ç–∏–∫–∞ settle –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.

---

### 1.4 Input –∏ media policy

| –§–∏—á–∞ | –°–ø–µ–∫–∞ | –ö–æ–¥ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-------|-----|--------|-------------|
| bindingKey | MUST | Enforced | ‚úÖ | –ß–µ—Ä–µ–∑ AnimValidator |
| allowedMedia (union) | MUST | –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è | ‚ö†Ô∏è | –ù–µ enforced –≤ —Ä–∞–Ω—Ç–∞–π–º–µ |
| —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π source | MUST | ‚ùå | üî• FIX | –ù–µ—Ç enforcement |
| emptyPolicy | MUST | ‚ùå | üî• FIX | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

---

### 1.5 Variants –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ç–∞–π–º–∏–Ω–≥–∞

| –§–∏—á–∞ | –°–ø–µ–∫–∞ | –ö–æ–¥ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-------|-----|--------|-------------|
| defaultDurationFrames | optional | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è | ‚ùå | |
| ifAnimationShorter | MUST | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è | ‚ùå | |
| ifAnimationLonger | MUST | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è | ‚ùå | |
| loop / loopRange | optional | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è | ‚ùå | |

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** clamp –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –∞–Ω–∏–º–∞—Ü–∏–∏.  \
**–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —Å–ø–µ–∫–µ:** —è–≤–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏.

üî• **–ù–µ–æ–±—Ö–æ–¥–∏–º —Ñ–∏–∫—Å –≤ `SceneRenderPlan.computeLocalFrameIndex()`**

---

## 2. Anim-x.json / Lottie (Bodymovin) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞

### 2.1 –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã —Å–ª–æ—ë–≤ (`ty`)

| –¢–∏–ø —Å–ª–æ—è | ty | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------|----|-----------|-------------|
| Image | 2 | ‚úÖ | –û—Å–Ω–æ–≤–Ω–æ–π media |
| Precomp | 0 | ‚úÖ | –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ |
| Null | 3 | ‚úÖ | –¢–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã |
| Shape | 4 | ‚ö†Ô∏è | –í –æ—Å–Ω–æ–≤–Ω–æ–º matte / mask |
| Solid | 1 | ‚ùå | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| Text | 5 | ‚ùå | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |

---

### 2.2 –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã (`ks`)

| –§–∏—á–∞ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-----------|-------------|
| position / scale / rotation / opacity | ‚úÖ | –ê–Ω–∏–º–∏—Ä—É–µ–º—ã–µ |
| anchor point | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| skew / skewAxis | ‚ùå | –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ |
| 3D —Å–ª–æ–∏ (ddd) | ‚ùå | –Ø–≤–Ω–∞—è –æ—à–∏–±–∫–∞ |
| auto-orient (ao) | ‚ùå | –Ø–≤–Ω–∞—è –æ—à–∏–±–∫–∞ |

---

### 2.3 Masks

| –§–∏—á–∞ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-----------|-------------|
| Mask path | ‚úÖ | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ |
| –¢–æ–ø–æ–ª–æ–≥–∏—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—É—Ç–∏ | ‚úÖ | –°—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| Inverted masks | ‚úÖ | |
| –†–µ–∂–∏–º—ã (add/sub/intersect) | ‚úÖ | –¢–æ–ª—å–∫–æ a/s/i |
| Expansion | ‚ùå | –î–æ–ª–∂–µ–Ω –±—ã—Ç—å 0 |

---

### 2.4 Track Mattes

| –§–∏—á–∞ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-----------|-------------|
| Alpha / AlphaInv | ‚úÖ | |
| Luma / LumaInv | ‚úÖ | |
| Nested precomp mattes | ‚ö†Ô∏è | –†–∞–Ω–µ–µ –±—ã–ª–∏ –±–∞–≥–∏, —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |

---

## 3. Shape support (ty=4)

### 3.1 Shape items

| –≠–ª–µ–º–µ–Ω—Ç | ty | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|----|-----------|-------------|
| Group | gr | ‚úÖ | –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω transform |
| Path | sh | ‚úÖ | –°—Ç–∞—Ç–∏—á–Ω—ã–π / –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π |
| Fill | fl | ‚úÖ | –¢–æ–ª—å–∫–æ solid |
| Stroke | st | ‚úÖ | Width –∏ dash –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è |
| Rect | rc | ‚úÖ | Roundness —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—á–Ω—ã–π |
| Ellipse | el | ‚úÖ | |
| Polystar | sr | ‚úÖ | |
| Trim Paths | tm | ‚ùå | –Ø–≤–Ω–∞—è –æ—à–∏–±–∫–∞ |
| Merge Paths | ‚Äî | ‚ùå | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| Repeater | ‚Äî | ‚ùå | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| Gradient Fill/Stroke | ‚Äî | ‚ùå | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |

---

### 3.2 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞

–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `supportedShapeTypes` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ:

```
["gr", "sh", "fl", "tr"]
```

–ü—Ä–∏ —ç—Ç–æ–º —Ä–µ–∞–ª—å–Ω—ã–π –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `rc / el / sr / st`.

üî• **–§–∏–∫—Å:** —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫.

---

### 3.3 –°–µ–º–∞–Ω—Ç–∏–∫–∞ shape layers (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å)

–°–µ–π—á–∞—Å:

- shape –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è
- –ø—É—Ç–∏ –∏ stroke —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- –≤ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–µ –µ—Å—Ç—å `drawShape / drawStroke`

–ù–æ:

- shape layers —Ç—Ä–∞–∫—Ç—É—é—Ç—Å—è –∫–∞–∫ **–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –º–∞—Å–æ–∫ / matte**, –∞ –Ω–µ –∫–∞–∫ –≤–∏–¥–∏–º–∞—è –≥—Ä–∞—Ñ–∏–∫–∞

**–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ:**

- –í–∞—Ä–∏–∞–Ω—Ç A: —è–≤–Ω–æ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤–∏–¥–∏–º—ã–µ shape layers (–∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
- –í–∞—Ä–∏–∞–Ω—Ç B: —Å–¥–µ–ª–∞—Ç—å shapes –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º–∏ –≤–∏–¥–∏–º—ã–º–∏ —Å–ª–æ—è–º–∏

–û—Å—Ç–∞–≤–ª—è—Ç—å —ç—Ç–æ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–º ‚Äî –æ–ø–∞—Å–Ω–æ.

---

## 4. –†–∏—Å–∫–∏ –Ω–∞ —Å—Ç—ã–∫–µ Scene √ó Lottie

| –ö–µ–π—Å | –û–∂–∏–¥–∞–Ω–∏–µ | –§–∞–∫—Ç | –†–∏—Å–∫ |
|------|----------|------|------|
| variant –∫–æ—Ä–æ—á–µ —Å—Ü–µ–Ω—ã | policy-based | clamp | High |
| –ø—É—Å—Ç–æ–π –±–ª–æ–∫ + hideWholeBlock | skip | —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è | High |
| background color | –≤–∏–¥–∏–º | –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | Medium |
| slotRectAfterSettle | –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π clip | –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π | Medium |
| nested matte –≤ precomp | –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ | —Ö—Ä—É–ø–∫–æ | Medium |

---

## 5. Fix-Now backlog (—É—Ä–æ–≤–µ–Ω—å PR)

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | PR | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----|----------|
| üî• | PR-01 | SceneValidator: —Ä–∞–∑—Ä–µ—à–∏—Ç—å slotRectAfterSettle |
| üî• | PR-02 | SceneRenderPlan: –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ loop –¥–ª—è variant |
| üî• | PR-03 | ScenePlayer: emptyPolicy –∏ enforcement –∞–∫—Ç–∏–≤–Ω–æ–≥–æ media |
| üî• | PR-04 | RenderPlan: —Ä–µ–Ω–¥–µ—Ä background |
| üî• | PR-05 | ScenePackageLoader: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ zip |
| üî• | PR-06 | AnimValidator: —Ñ–∏–∫c supportedShapeTypes |
| ‚ö†Ô∏è | PR-07 | –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–µ–º–∞–Ω—Ç–∏–∫—É shape layers |

---

## 6. Render / Metal ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

### 6.1 Masks (GPU mask pipeline)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

- –ú–∞—Å–∫–∏ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —á–µ—Ä–µ–∑ GPU coverage textures (`r8Unorm`) + compute kernel.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è boolean-—Ä–µ–∂–∏–º—ã: add / subtract / intersect.
- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ mask paths –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–æ —Ç–æ–ø–æ–ª–æ–≥–∏–∏.

**–†–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏**

- Fill rule –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω —è–≤–Ω–æ (triangulation-based); –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å AE non-zero.
- –ù–µ—Ç anti-aliasing –Ω–∞ –∫—Ä–∞—è—Ö –º–∞—Å–æ–∫ ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã ¬´–ª–µ—Å–µ–Ω–∫–∏¬ª.

**Fix-now**

- –Ø–≤–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å fill rule.
- –î–æ–±–∞–≤–∏—Ç—å AA –¥–ª—è –º–∞—Å–æ–∫ (–º–∏–Ω–∏–º—É–º –¥–ª—è export path).
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è CPU vs GPU –º–∞—Å–æ–∫.

---

### 6.2 Track Mattes (Alpha / Luma)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è Alpha / AlphaInv / Luma / LumaInv.
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ offscreen textures –∏ composite shader.

**–†–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏**

- Luma –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (sRGB vs linear).
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–∏–π premultiplied alpha –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

**Fix-now**

- Enforce premultiplied alpha –¥–ª—è image/video –ø–∞–π–ø–ª–∞–π–Ω–æ–≤.
- –î–æ–±–∞–≤–∏—Ç—å golden-tests –¥–ª—è alpha –∏ luma mattes.

---

### 6.3 Precomp transforms –∏ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

- Parent transforms –ø–æ–¥–¥–µ—Ä–∂–∞–Ω—ã.
- Nested precomps + masks –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ —Ö—Ä—É–ø–∫–æ–µ –º–µ—Å—Ç–æ.

**–†–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏**

- –î–≤–æ–π–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø–æ—Ç–µ—Ä—è parent transform.
- –ú–∞—Å–∫–∏/mattes —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –Ω–µ –≤ —Ç–µ—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö.

**Fix-now**

- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–¥–∏–Ω—ã–π source-of-truth –¥–ª—è transform propagation.
- –î–æ–±–∞–≤–∏—Ç—å smoke-tests: –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ + nested precomp + mask.

---

### 6.4 Clipping (Scissor / Mask)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

- –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π clip ‚Äî —á–µ—Ä–µ–∑ Metal scissor.
- –°–ª–æ–∂–Ω—ã–π clip ‚Äî —á–µ—Ä–µ–∑ mask textures.

**–†–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏**

- –û—à–∏–±–∫–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—è—Ö (1px leaks) –Ω–∞ scale 2x/3x.

**Fix-now**

- –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è rect ‚Üí scissor.
- –î–æ–±–∞–≤–∏—Ç—å regression-—Ç–µ—Å—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö scale.

---

### 6.5 Blending –∏ alpha

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

- Premultiplied alpha blending –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–†–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏**

- Straight-alpha –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–¥—É—Ç –æ—Ä–µ–æ–ª—ã.

**Fix-now**

- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å straight-alpha —Ç–µ–∫—Å—Ç—É—Ä—ã.
- –î–æ–±–∞–≤–∏—Ç—å edge-case —Ç–µ—Å—Ç—ã –¥–ª—è PNG.

---

## 7. Performance & Caching

### 7.1 –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

- TexturePool —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –ö–µ—à–∏ shape –∏ path
- Ring buffer –¥–ª—è vertex upload
- PerfMetrics –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

---

### 7.2 –†–æ—Å—Ç –ø–∞–º—è—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞**

- –£ TexturePool –Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –ø–∞–º—è—Ç–∏.

**Fix-now**

- –í–≤–µ—Å—Ç–∏ –ª–∏–º–∏—Ç –Ω–∞ –æ–±—â–∏–π –æ–±—ä—ë–º –ø–∞–º—è—Ç–∏ + LRU eviction.
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç—É—Ä –Ω–∞ –∫–ª—é—á.

---

### 7.3 –î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º –∫–µ—à–µ–π

**–†–∏—Å–∫**

- –ö–ª—é—á–∏ –∫–µ—à–µ–π –∑–∞–≤–∏—Å—è—Ç –æ—Ç float ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–º–∞—Ö–∏.

**Fix-now**

- –ö–≤–∞–Ω—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å float –ø–µ—Ä–µ–¥ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

---

### 7.4 Export path

**–†–∏—Å–∫**

- –î–ª–∏–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç-—Å–µ—Å—Å–∏–∏ –º–æ–≥—É—Ç –±–µ—Å–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ —Ä–∞–∑–¥—É–≤–∞—Ç—å –∫–µ—à–∏.

**Fix-now**

- –î–æ–±–∞–≤–∏—Ç—å lifecycle: `beginExportSession / endExportSession`.
- –°–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –∫–µ—à–∏ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç.

---

### 7.5 –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**Fix-now**

- –î–æ–±–∞–≤–∏—Ç—å memory-—Å—á—ë—Ç—á–∏–∫–∏ –≤ PerfMetrics:
  - pooled bytes
  - offscreen peak bytes
  - texture count

---

## 8. Fix-Now backlog (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | PR | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----|----------|
| üî• | PR-01 | SceneValidator: —Ä–∞–∑—Ä–µ—à–∏—Ç—å slotRectAfterSettle |
| üî• | PR-02 | SceneRenderPlan: –ø–æ–ª–∏—Ç–∏–∫–∏ —Ç–∞–π–º–∏–Ω–≥–∞ –∏ loop |
| üî• | PR-03 | ScenePlayer: emptyPolicy –∏ active media enforcement |
| üî• | PR-04 | RenderPlan: —Ä–µ–Ω–¥–µ—Ä background |
| üî• | PR-05 | ScenePackageLoader: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ zip |
| üî• | PR-06 | AnimValidator: –∏—Å–ø—Ä–∞–≤–∏—Ç—å supportedShapeTypes |
| üî• | PR-07 | Enforce premultiplied alpha pipeline |
| üî• | PR-08 | TexturePool: –ª–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏ + LRU |
| ‚ö†Ô∏è | PR-09 | Anti-aliasing –¥–ª—è –º–∞—Å–æ–∫ |
| ‚ö†Ô∏è | PR-10 | Lifecycle export-—Å–µ—Å—Å–∏–∏ |

---

## 9. –§–∏–Ω–∞–ª—å–Ω—ã–π –≤–µ—Ä–¥–∏–∫—Ç

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–≤–∏–∂–∫–∞ **–≤ —Ü–µ–ª–æ–º production-capable**, –Ω–æ **–ø–æ–∫–∞ –Ω–µ production-safe** –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤ –≤—ã—à–µ.

–ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è üî• Fix-Now backlog —Å–∏—Å—Ç–µ–º–∞:

- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É Scene.json
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç AE masks / mattes / precomps
- –æ—Å—Ç–∞—ë—Ç—Å—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–æ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ playback –∏ export

–î–æ–∫—É–º–µ–Ω—Ç **–≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** –∫–∞–∫ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

